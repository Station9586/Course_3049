# 專案報告：(2,4)-視覺密碼學實現 (灰階影像)

## 1. 專案簡介

本專案旨在實現一個基於 (2,4) 門檻的視覺密碼學 (Visual Cryptography, VC) 系統。該系統能將一張秘密的灰階影像加密成四張分享圖 (shares)。單獨觀察任何一張分享圖時，無法獲得關於原始秘密影像的任何資訊。然而，當任意兩張分享圖實體疊加時，原始的秘密影像便能以視覺方式還原出來。

專案的核心挑戰在於將傳統針對二元影像的視覺密碼學原理擴展至灰階影像，並確保 (2,4) 門檻機制下的安全性與解密效果。

**關鍵技術點：**

* **灰階影像處理：** 使用 Floyd-Steinberg 抖色 (Dithering) 演算法將輸入的灰階影像轉換為二元影像，以便套用視覺密碼學的編碼規則，同時在視覺上保留原始影像的灰階層次感
* **(2,4)-VC 編碼機制：** 設計並實現一套針對二元影像的 (2,4) 門檻視覺密碼學編碼方案。此方案將每個秘密像素擴展為 2x2 的子像素區塊，並根據像素是黑 (`BLACK_SUBPIXEL = 0`) 或白 (`WHITE_SUBPIXEL = 255`)，以及 (2,4) 機制的要求，為四張分享圖分配特定的子像素圖案
* **安全性與解密：**
    * **安全性：** 確保單獨一張分享圖看起來是隨機的，不洩漏原始秘密
    * **解密性：** 任意兩張分享圖透過位元運算疊加後，能有效還原秘密影像，黑色與白色秘密區域在疊加後能產生顯著的視覺對比

## 2. 系統架構與演算法說明

### 2.1 系統流程

系統主要包含以下步驟：

1.  **讀取秘密影像：** 輸入一張灰階影像 (`cv::IMREAD_GRAYSCALE`) 作為原始秘密
2.  **抖色處理 (`floyd_steinberg_dithering`)：**
    * 將讀入的灰階影像透過 Floyd-Steinberg 抖色演算法轉換為二元影像 (像素值為 `0` 或 `255`)。此步驟是為了讓後續的視覺密碼學編碼能夠處理，同時在視覺上模擬灰階
    * **Floyd-Steinberg 演算法簡述：**
        1.  從左至右、從上至下遍歷影像像素
        2.  將目前像素的灰階值（程式中以 `127.0f` 為閾值）量化為最接近的純黑 (`0`) 或純白 (`255`)
        3.  計算量化誤差 (`quant_error`)
        4.  將此誤差按 `7/16`, `3/16`, `5/16`, `1/16` 的比例擴散到其右方、左下方、正下方及右下方的鄰近未處理像素
3.  **(2,4)-VC 分享圖產生 (`generate_shares_2_4`)：**
    * 針對抖色後的二元影像中的每一個像素，執行以下操作，將其擴展為 2x2 的子像素區塊
    * **基礎圖案定義：**
        * 程式碼中預先定義了6種 2x2 的基礎圖案 (`base_2b2w_patterns`)，每種圖案均包含2個黑色子像素和2個白色子像素。它們被組織成三對互補圖案：
            * `P0 = [[0,0],[255,255]]` 與 `P1 = [[255,255],[0,0]]` (互補)
            * `P2 = [[0,255],[0,255]]` 與 `P3 = [[255,0],[255,0]]` (互補)
            * `P4 = [[0,255],[255,0]]` 與 `P5 = [[255,0],[0,255]]` (互補)
    * **白色秘密像素編碼 (`secret_pixel_value == WHITE_SUBPIXEL`)：**
        1.  使用 `std::uniform_int_distribution` 從6個基礎圖案 (`P0` 至 `P5`) 中隨機選擇一個
        2.  將4張分享圖 ($S_1, S_2, S_3, S_4$) 在該像素位置的 2x2 子像素區塊均設為此相同的圖案
    * **黑色秘密像素編碼 (`secret_pixel_value == BLACK_SUBPIXEL`)：**
        1.  **選擇互補圖案對：** 首先，使用 `distrib_complementary_pairs` 從三對互補圖案中隨機選擇一對（例如，選中第0對，即 `pattern_A = P0`, `pattern_Not_A = P1`）
        2.  **分配圖案：** 接著，使用 `black_scheme_choice` 從以下三種分配模式中隨機選擇一種，將選定的 `pattern_A` 和 `pattern_Not_A` 分配給四張分享圖：
            * **模式 0 (`scheme == 0`)：** $S_1=A, S_2=A, S_3=\neg A, S_4=\neg A$
            * **模式 1 (`scheme == 1`)：** $S_1=A, S_2=\neg A, S_3=A, S_4=\neg A$
            * **模式 2 (`scheme == 2`)：** $S_1=A, S_2=\neg A, S_3=\neg A, S_4=A$
4.  **分享圖疊加 (`overlay_any_2_of_4_shares`)：**
    * 任意選擇兩張產生的分享圖
    * 將這兩張分享圖對應的像素進行位元 `AND` (`cv::bitwise_and`) 運算，得到還原後的秘密影像
    * **預期疊加效果：**
        * 若原始像素為**白色**：兩張分享圖的圖案相同 (例如均為 $P_k$)，疊加結果 $P_k \text{ AND } P_k$ 仍為 $P_k$，含有**2個黑色子像素**
        * 若原始像素為**黑色**：
            * 若兩張分享圖使用了**相同的**基礎圖案 (例如模式0中的 $S_1$ 和 $S_2$，均為 $A$)，疊加結果為 $A \text{ AND } A = A$，含有**2個黑色子像素**
            * 若兩張分享圖使用了**互補的**基礎圖案 (例如模式0中的 $S_1$ 和 $S_3$，分別為 $A$ 和 $\neg A$)，疊加結果為 $A \text{ AND } \neg A$，產生全黑的 2x2 區塊，含有**4個黑色子像素**
        * 這種設計使得疊加後，來自黑色秘密區域的像素（平均有 $2/3$ 的機率是4黑， $1/3$ 的機率是2黑）會比來自白色秘密區域的像素（固定為2黑）更黑，從而產生視覺對比

### 2.2 安全性分析

* **單張分享圖安全性 (k-1)：** 根據所採用的 (2,4)-VC 構造方法，每一張分享圖（無論原始秘密像素是黑是白）其 2x2 子像素區塊都是從6個基礎圖案中選出，固定包含2個黑色和2個白色子像素。因此，從單獨一張分享圖的外觀上，無法判斷原始秘密像素的顏色，滿足安全性要求
* **(k,n) 門檻特性：** 任意兩張分享圖疊加後，可以還原出帶有視覺對比的秘密影像，滿足 (2,4) 門檻特性

## 3. 實驗結果與分析

**輸入影像：**

`original_secret_grayscale.png`

**抖色後影像：**

`dithered_secret_2_4.png`
*說明：* 原始灰階影像經過 Floyd-Steinberg 抖色處理後，轉換為僅包含純黑與純白像素的二元影像，但宏觀上仍保留了灰階的視覺感受

**分享圖範例 (單張)：**

`share1_2_4.png`
*說明：* 單張分享圖看起來是隨機的雜訊，每個 2x2 子像素區塊包含2個黑色和2個白色子像素

**疊加結果範例：**

* **Share1 + Share2 (`revealed_s1s2_2_4.png`)**
    (圖片)
* **Share1 + Share3 (`revealed_s1s3_2_4.png`)**
    (圖片)
* **Share3 + Share4 (`revealed_s3s4_2_4.png`)**
    (圖片)

*分析：*
從疊加結果可以看出，原始影像的輪廓被成功還原。在原始影像的黑色區域，部分分享圖組合（例如 Share1+Share3，取決於黑色像素編碼時的隨機分配）疊加後呈現更深的黑色（接近全黑的 2x2 子塊），而在原始影像的白色區域，疊加結果則呈現固定的2黑2白子像素圖案。這種對比使得秘密影像得以被辨識。不同的分享圖組合可能產生略微不同的還原效果（特別是在黑色區域的“黑度”上），但都能揭示秘密。

## 4. 結論與未來展望

本專案成功實作了一個 (2,4)-視覺密碼學系統，能夠對灰階影像進行加密與解密。透過 Floyd-Steinberg 抖色處理，有效地將灰階資訊轉換為適合二元視覺密碼學處理的形式。所設計的 (2,4)-VC 編碼機制，確保了單張分享圖的安全性，並允許使用任意兩張分享圖還原秘密。實驗結果驗證了該系統的可行性與有效性。

**未來可改進或擴展的方向：**

* **優化分享圖品質：** 研究更進階的抖色演算法或直接針對灰階的視覺密碼學方案，以期在還原秘密影像時獲得更好的灰階層次與視覺品質
* **實現「有意義的分享圖」：** 目前的分享圖是隨機雜訊狀的。可以研究將分享圖資訊嵌入到看似無關的有意義影像中 (Steganography in VC)，以降低分享圖被注意到的可能性
* **擴展到彩色影像：** 將目前的灰階影像處理擴展到彩色影像的視覺密碼學
* **更廣泛的 (k,n) 機制：** 實作更通用的 (k,n) 門檻機制，例如 (3,5)-VC 等

## 5. 參考資料

* Naor, M., & Shamir, A. (1995). Visual cryptography. In *Advances in Cryptology EUROCRYPT'94* (pp. 1-12). Springer Berlin Heidelberg.
* Floyd, R. W., & Steinberg, L. (1976). An adaptive algorithm for spatial grey scale. *SID 76 DIGEST, 17*(1), 36-37.
* (其他您在專案中參考的相關論文或書籍)

## 6. 程式碼結構與使用說明

* **主要函式：**
    * `floyd_steinberg_dithering()`: 執行抖色處理
    * `generate_shares_2_4()`: 產生4張 (2,4)-VC 分享圖
    * `overlay_any_2_of_4_shares()`: 疊加任意2張分享圖
* **編譯與執行：**
    `g++ your_code_file.cpp -o vc_project $(pkg-config --cflags --libs opencv4)`
* **使用範例：**
    `./vc_project` (並確保輸入影像 `img/image.png` 存在，輸出目錄 `result/` 已建立)